## 8.1SystemUI设计构思：
  - SystemUI作为Android系统核心应用，负责反馈系统及应用状态并与用户保持大量的交互。主要包括StatusBar（状态栏）、NavigationBar（导航栏）与Notification Panel（通知栏），以及Recents（近期任务界面），使用起来方便又快捷。
  - Android原生的SystemUI适合小屏幕的移动设备，为了提高其在桌面端的使用感，适应多窗口管理系统的操作，并且考虑到后期优化和功能更新，本着尽量降低与原生SystemUI耦合性的原则，重新设计了SystemUI。任务栏舍弃原生StatusBar，引入功能更多、界面更美观的TaskBar，便于对任务栏的自定义，导航栏功能重构后布局放在任务栏右侧，并将开始菜单以Dialog形式集成在TaskBar之上，代码更加独立。通知栏也改为自定义形式，便于后期管理。

## SystemUI交互设计：
### Alt-Tab功能实现
  - 按下Alt-Tab快捷键，可调出近期任务界面，展示当前正在运行的应用界面，用户可选择切换到某个应用，移除单个应用，或是一键关闭所有应用，能够更方便快捷的操作应用窗口。Android8.1原生的近期任务界面功能已较为完整，但打开后会占据整个屏幕，遮挡桌面正在运行的应用界面，与桌面端多窗口设计理念不符，因此重构此部分界面和功能，保证与多窗口管理模块功能的一致性，和良好的交互。
  - Alt-Tab快捷键功能的实现主要包括系统快捷键的拦截处理，系统中正在运行应用的快照，以及近期任务界面的实现三部分。
系统快捷键的拦截在PhoneWindowManager中，在按键事件分发之前将Alt键和Tab键拦截下来，通过对按键属性的分析，交由Recents控制近期任务界面的显示和隐藏，以及应用的切换；
  - 系统中正在运行应用的快照，当有任务进入后台时，窗口管理器会将该任务的屏幕截图TaskSnapshort放入一个图形缓冲区中。只要任务顶层 Activity 的应用保留在内存中，该图形缓冲区就会保留在内存中。打开最近任务界面是，从缓冲区中取出该任务的TaskSnapshort，作为应用图标。
  - 近期任务界面的实现，构造一个系统弹窗(Dialog)，在用户按下Alt-tab键后展示在屏幕中心，弹框周围屏幕暗下，弹框中展示当前正在运行的应用图标和名称。用户按下Alt-Tab键打开弹窗后，按住Alt键不松手，弹窗接收Tab按键的按下和抬起，在列表中的应用中进行选择，松开Alt和Tab后，通过AMS的窗口操作将选中的应用移到栈顶，并设置焦点。，单个应用图标增加删除按钮，可以单独移除此应用，通过AMS将应用从近期任务列表中移除。弹框左下角增加“清除所有”按钮，可一键关闭所有应用，实现方法为遍历列表中所有应用，逐个移除。
  - 近期任务列表中较为特殊的应用为Launcher3桌面，根据对Linux、Windows等操作系统此功能的调研，当用户切换到桌面时，通过AMS的窗口操作，将桌面所有应用保存到集合中，并移动到BACKGROUND_TASK栈中，使其不再显示，仅展示桌面，再次切换到桌面时，将集合中的应用还原到桌面。如期间用户有窗口操作，如打开、关闭应用等，需将集合清空，保证用户每次的窗口操作都是针对最近桌面上的应用进行。SystemUI的回到桌面功能与此原理一致。
  - ![](https://github.com/openthos/systemui-analysis/blob/master/ImageView/alt-tab.png)

